<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:insert="partial/partials :: head">
    <meta charset="UTF-8">
    <title id="pageTitle">Find Recipe</title>
</head>

<body>
<nav th:insert="partial/partials :: navbar"></nav>
<div class="container-fluid content">
    <h2 class="p-2" style="text-align: center;" sec:authorize="!isAuthenticated()">Search for Recipes</h2>
    <h2 class="p-2" style="text-align: center;" sec:authorize="isAuthenticated()">Recommended Recipes for You</h2>

    <div class="body d-flex justify-content-evenly">
        <div id="carouselExampleIndicators" class="carousel slide carousel-fade" data-bs-ride="carousel">
            <div class="carousel-inner carousel-container" sec:authorize="isAuthenticated()">
                <div th:each="recipe : ${finalRecipes}" th:class="${recipe.showThis} ? 'carousel-item active' : 'carousel-item'" data-bs-interval="10000">
                    <a th:href="@{'/recipe/'} + ${recipe.getIdMeal()}">
                        <img alt="..." class="d-block w-100 carousel-image" th:src="${recipe.getStrMealThumb()}">
                    </a>
                    <div class="carousel-caption d-none d-md-block">
                        <h2 th:text="${recipe.getStrMeal()}" class="capitalize btn p-3 mb-2 bg-secondary text-white rounded-pill opacity-75 h-50 d-inline-block fs-3"></h2>
                    </div>
                </div>
            </div>

            <div class="carousel-inner carousel-container" sec:authorize="!isAuthenticated()">
                <div th:each="recipe : ${finalRecipes}" th:class="${recipe.showThis} ? 'carousel-item active' : 'carousel-item'" data-bs-interval="10000">
                    <a th:href="@{'/login/'} + ${recipe.getIdMeal()}">
<!--                    <a th:href="@{/login}" >-->
                        <img alt="..." class="d-block w-100 carousel-image" th:src="${recipe.getStrMealThumb()}">
                    </a>
                    <div class="carousel-caption d-none d-md-block">
                        <h2 th:text="${recipe.getStrMeal()}" class="capitalize btn p-3 mb-2 bg-secondary text-white rounded-pill opacity-75 h-50 d-inline-block fs-3"></h2>
                    </div>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>

        </div>
    </div>
</div>
<div class="row p-2" >
    <div>
    <div sec:authorize="isAuthenticated()" class="d-flex justify-content-evenly container">
            <input type="text" id="search" placeholder="Search Meals or Categories" class="w-30 col-6 rounded border border-info">
        <div sec:authorize="isAuthenticated()">
            <select  class="selectpicker show-tick rounded border border-info" id="category" style="width: 15rem; height: 4rem">
                <option value="" selected>Show All Categories</option>
                <option value="Beef">Beef</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Chicken">Chicken</option>
                <option value="Dessert">Dessert</option>
                <option value="Goat">Goat</option>
                <option value="Lamb">Lamb</option>
                <option value="Pasta">Pasta</option>
                <option value="Pork">Pork</option>
                <option value="Seafood">Seafood</option>
                <option value="Side">Side</option>
                <option value="Starter">Starter</option>
                <option value="Vegan">Vegan</option>
                <option value="Vegetarian">Vegetarian</option>
                <option value="Miscellaneous">Miscellaneous</option>
            </select>
</div>
    </div>
        <div sec:authorize="isAuthenticated()">
<ul class="list-group p-2">
    <li class="list-group-item" >
        <div th:href="@{'/recipe/' + ${idmeal}}" id="recipes"></div>
    </li>
</ul>
        </div>

<!--    <div th:href="@{'/recipe/' + ${idmeal}}" sec:authorize="isAuthenticated()" id="recipes"></div>-->
<footer th:insert="partial/partials :: footer"></footer>
<script>
    const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('').sort();
    const recipesContainer = document.getElementById('recipes');
    const searchInput = document.getElementById('search');
    const CategoryInput = document.getElementById('category');

    alphabet.forEach(letter => {
        fetch(`https://www.themealdb.com/api/json/v2/1/search.php?f=${letter}`)
            .then(response => response.json())
            .then(data => {
                const meals = data.meals;
                meals.forEach(meal => {
                    const card = document.createElement('div');
                    card.classList.add('card');

                    const cardHeader = document.createElement('div');
                    cardHeader.classList.add('card-body');
                    cardHeader.classList.add('capitalize');

                    const ID = document.createElement('a');
                    ID.innerText = meal.strMeal;
                    ID.setAttribute('href', `/recipe/${meal.idMeal}`); // Add the href attribute with the meal id
                    ID.setAttribute('id', meal.idMeal); // Set the id attribute to the meal id
                    const cat = document.createElement('p');
                    cat.innerText = meal.strCategory;
                    const heading = document.createElement('h1');
                    heading.innerText = meal.strMeal;

                    cardHeader.appendChild(ID);
                    cardHeader.appendChild(cat);
                    card.appendChild(cardHeader);

                    const image = document.createElement('img');
                    image.src = meal.strMealThumb;
                    image.alt = meal.strMeal;
                    const ingredients = document.createElement('ul');
                    for (let i = 1; i <= 20; i++) {
                        const ingredient = meal[`strIngredient${i}`];
                        if (ingredient) {
                            const listItem = document.createElement('li');
                            listItem.innerText = ingredient;
                            ingredients.appendChild(listItem);
                        }
                    }
                    const instructions = document.createElement('p');
                    instructions.innerText = meal.strInstructions;

                    recipesContainer.appendChild(card);
                });
            })
            .catch(error => console.error(error));
    });

    searchInput.addEventListener('input', () => {
        const searchValue = searchInput.value.toLowerCase();
        const cards = recipesContainer.querySelectorAll('.card');
        cards.forEach(card => {
            const title = card.querySelector('div').innerText.toLowerCase();
            if (title.includes(searchValue)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }); CategoryInput.addEventListener('input', () => {
        const searchValue = CategoryInput.value.toLowerCase();
        const cards = recipesContainer.querySelectorAll('.card');
        cards.forEach(card => {
            const category = card.querySelector('p').innerText.toLowerCase();
            if (searchValue === '' || category.includes(searchValue)) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    });
</script>

</body>
</html>